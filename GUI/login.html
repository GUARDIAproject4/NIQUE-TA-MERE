<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Connexion ‚Äî Guardia</title>
</head>
<body>
    <main class="wrap" role="main">
        <section class="promo" aria-hidden="false">
            <div class="brand">
                <div class="logo" aria-hidden="true">G</div>
                <div>
                    <h1>Guardia ‚Äî Connexion</h1>
                    <div style="font-size:13px;color:var(--muted)">S√©curis√© ‚Ä¢ Professionnel ‚Ä¢ Accessible</div>
                </div>
            </div>
            <p class="lead">Acc√©dez √† votre espace personnel en toute s√©curit√©.</p>
        </section>
     <div class="security-card">
        <h3>üõ°Ô∏è V√©rification de Mots de Passe (API S√©curis√©e)</h3>
        <p style="color: var(--text-muted); margin-bottom: 5px;">V√©rifiez si un mot de passe a √©t√© pirat√© sans le r√©v√©ler (k-Anonymity).</p>
        <div class="sec-input-group">
            <input type="password" id="secPwd" placeholder="Entrez un mot de passe √† tester...">
            <button class="action-btn" onclick="verifierSecurite()">V√©rifier</button>
        </div>
        <div id="secResult" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
        <section class="card" aria-labelledby="login-title">
            <h2 id="login-title" style="margin:0 0 6px 0">Se connecter</h2>
            <p style="margin:0 0 14px 0;color:var(--muted)">Entrez vos identifiants pour acc√©der √† votre compte.</p>

            <!-- zone o√π Python peut afficher un message -->
            <div id="pyMsg" aria-live="polite" style="font-size:13px;color:var(--muted);margin-bottom:8px"></div>

            <form id="loginForm" method="post" novalidate>
                <div class="form-row">
                    <div>
                        <label for="username">Nom d'utilisateur</label>
                        <input id="username" name="username" type="text" autocomplete="username" required />
                        <div class="errors" id="err-username" aria-live="polite"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label for="password">Mot de passe</label>
                        <div class="password-wrap">
                            <input id="password" name="password" type="password" autocomplete="current-password" required />
                            <button type="button" class="toggle-eye" id="togglePwd" aria-label="Afficher le mot de passe">üëÅÔ∏è</button>
                        </div>
                        <div class="errors" id="err-password" aria-live="polite"></div>
                    </div>
                </div>

                <div class="controls" style="margin: 16px 0;">
                    <label class="checkbox">
                        <input type="checkbox" id="remember" name="remember">
                        <span>Se souvenir de moi</span>
                    </label>
                    <div style="font-size:13px;color:var(--muted); margin-top: 8px;">
                        <a href="#" style="color:var(--accent);text-decoration:none">Mot de passe oubli√© ?</a>
                    </div>
                </div>

                <div style="display:flex; gap:12px; align-items:center; margin-top:6px;">
                    <button id="loginBtn" class="btn" type="submit">Se connecter</button>
                    <div id="progress" style="color:var(--muted);font-size:13px;display:none">Connexion en cours...</div>
                </div>
                <div id="message" style="margin: 10px 0; padding: 10px; border-radius: 4px; display: none;"></div>
            </form>

            <div style="text-align: center; margin-top: 20px; font-size: 13px; color: var(--muted);">
                Pas encore de compte ? <a href="template.html" style="color:var(--accent);text-decoration:none">S'inscrire</a>
            </div>
        </section>
    </main>

    <script>
    // --- 1. FONCTION SECURIT√â (Version Debug) ---
    function verifierSecurite() {
        var pwd = document.getElementById('secPwd').value;
        var res = document.getElementById('secResult');
        
        // Affiche la bo√Æte imm√©diatement
        if(!pwd) { 
            res.style.display = "block";
            res.style.backgroundColor = "#f8d7da"; // Rouge clair
            res.style.color = "#721c24";
            res.innerText = "‚ö†Ô∏è Veuillez √©crire un mot de passe."; 
            return; 
        }

        // Etat "En cours"
        res.style.display = "block";
        res.style.backgroundColor = "#e2e3e5"; // Gris clair
        res.style.color = "#383d41";
        res.innerHTML = "‚è≥ Analyse en cours...";

        if(window.pywebview) {
            window.pywebview.api.check_security(pwd)
            .then(function(resp) {
                res.innerHTML = resp.message;
                
                if(resp.status === 'danger') {
                    // ROUGE (Danger)
                    res.style.backgroundColor = "#f8d7da"; 
                    res.style.color = "#dc3545";
                    res.style.border = "1px solid #f5c6cb";
                } else if(resp.status === 'safe') {
                    // VERT (S√ªr)
                    res.style.backgroundColor = "#d4edda";
                    res.style.color = "#155724";
                    res.style.border = "1px solid #c3e6cb";
                } else {
                    // JAUNE (Erreur)
                    res.style.backgroundColor = "#fff3cd";
                    res.style.color = "#856404";
                }
            })
            .catch(function(err) {
                res.innerText = "Erreur Python : " + err;
                res.style.backgroundColor = "orange";
            });
        } else {
            res.innerText = "Erreur : Lancez via Python (gui.py)";
        }
    }

    // --- 2. FONCTION CONNEXION ---
    function handleLogin() {
        var u = document.getElementById('username').value;
        var p = document.getElementById('password').value;
        var msg = document.getElementById('loginMsg');

        if(window.pywebview) {
            window.pywebview.api.login(u, p).then(function(ok) {
                if(ok) {
                    msg.innerText = "Connexion r√©ussie...";
                    msg.style.color = "green";
                    setTimeout(function(){ window.location.href = 'dashboard.html'; }, 1000);
                } else {
                    msg.innerText = "Identifiants incorrects (Essayez admin/admin)";
                    msg.style.color = "red";
                }
            });
        }
    }

        // Fonction pour basculer la visibilit√© du mot de passe
        document.getElementById('togglePwd').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
        });

        // Gestion de la soumission du formulaire
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // R√©initialisation des messages d'erreur
            document.querySelectorAll('.errors').forEach(el => el.textContent = '');
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = '';
            messageDiv.style.display = 'none';
            
            // Validation simple
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const progress = document.getElementById('progress');
            
            let isValid = true;
            
            if (!username) {
                document.getElementById('err-username').textContent = 'Le nom d\'utilisateur est requis';
                isValid = false;
            }
            
            if (!password) {
                document.getElementById('err-password').textContent = 'Le mot de passe est requis';
                isValid = false;
            }
            
            if (isValid) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Connexion...';
                progress.style.display = 'block';
                
                window.pywebview.api.handle_login(username, password)
                    .then(function(response) {
                        messageDiv.textContent = response.message;
                        messageDiv.style.color = response.success ? 'green' : 'red';
                        messageDiv.style.display = 'block';
                        
                        if (response.success) {
                            // Rediriger vers le tableau de bord apr√®s connexion r√©ussie
                            setTimeout(function() {
                                window.pywebview.api.navigate('dashboard');
                            }, 1000);
                        } else {
                            loginBtn.disabled = false;
                            loginBtn.textContent = 'Se connecter';
                            progress.style.display = 'none';
                        }
                    })
                    .catch(function(error) {
                        console.error('Erreur lors de la connexion:', error);
                        messageDiv.textContent = 'Une erreur est survenue lors de la connexion';
                        messageDiv.style.color = 'red';
                        messageDiv.style.display = 'block';
                        
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Se connecter';
                        progress.style.display = 'none';
                    });
            }
        });

        // Permet √† Python d'envoyer un message visible
        function updateMessage(msg) {
            const el = document.getElementById('pyMsg');
            if (el) el.textContent = msg;
            else console.log(msg);
        }
    </script>
    <style>/* Widget S√©curit√© */
        .security-card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-left: 5px solid var(--primary);
        }
        .sec-input-group { display: flex; gap: 10px; margin-top: 10px; }
        input { 
            padding: 10px; border: 1px solid var(--border); border-radius: 4px; 
            background: var(--input-bg); color: var(--text-main); flex: 1;
        }</style>
    <!-- INJECT_CSS -->
</body>
</html>
